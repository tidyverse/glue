<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>How to write a function that wraps glue • glue</title>
<!-- favicons --><link rel="icon" type="image/png" sizes="16x16" href="../favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="../favicon-32x32.png">
<link rel="apple-touch-icon" type="image/png" sizes="180x180" href="../apple-touch-icon.png">
<link rel="apple-touch-icon" type="image/png" sizes="120x120" href="../apple-touch-icon-120x120.png">
<link rel="apple-touch-icon" type="image/png" sizes="76x76" href="../apple-touch-icon-76x76.png">
<link rel="apple-touch-icon" type="image/png" sizes="60x60" href="../apple-touch-icon-60x60.png">
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../deps/Source_Sans_Pro-0.4.9/font.css" rel="stylesheet">
<link href="../deps/Source_Code_Pro-0.4.9/font.css" rel="stylesheet">
<link href="../deps/font-awesome-6.4.2/css/all.min.css" rel="stylesheet">
<link href="../deps/font-awesome-6.4.2/css/v4-shims.min.css" rel="stylesheet">
<script src="../deps/headroom-0.11.0/headroom.min.js"></script><script src="../deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="../deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="../deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="../deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="../deps/search-1.0.0/fuse.min.js"></script><script src="../deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="How to write a function that wraps glue">
<meta name="robots" content="noindex">
<!-- Global site tag (gtag.js) - Google Analytics --><script async src="https://www.googletagmanager.com/gtag/js?id=UA-115082821-1"></script><script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'UA-115082821-1');
</script><script defer data-domain="glue.tidyverse.org,all.tidyverse.org" src="https://plausible.io/js/plausible.js"></script>
</head>
<body>
    <a href="#container" class="visually-hidden-focusable">Skip to content</a>


    <nav class="navbar navbar-expand-lg fixed-top bg-none" data-bs-theme="light" aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="../index.html">glue</a>

    <small class="nav-text text-danger me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="In-development version">1.7.0.9000</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item"><a class="nav-link" href="../articles/glue.html">Get started</a></li>
<li class="nav-item"><a class="nav-link" href="../reference/index.html">Reference</a></li>
<li class="active nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-articles" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">Articles</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-articles">
<li><a class="dropdown-item" href="../articles/engines.html">glue custom knitr language engines</a></li>
    <li><a class="dropdown-item" href="../articles/speed.html">Speed of glue</a></li>
    <li><a class="dropdown-item" href="../articles/transformers.html">Transformers</a></li>
    <li><a class="dropdown-item" href="../articles/wrappers.html">How to write a function that wraps glue</a></li>
  </ul>
</li>
<li class="nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-news" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">News</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-news">
<li><h6 class="dropdown-header" data-toc-skip>Releases</h6></li>
    <li><a class="external-link dropdown-item" href="https://www.tidyverse.org/blog/2017/10/glue-1.2.0/">glue 1.2.0</a></li>
    <li><hr class="dropdown-divider"></li>
    <li><a class="dropdown-item" href="../news/index.html">Changelog</a></li>
  </ul>
</li>
      </ul>
<ul class="navbar-nav">
<li class="nav-item"><form class="form-inline" role="search">
 <input class="form-control" type="search" name="search-input" id="search-input" autocomplete="off" aria-label="Search site" placeholder="Search for" data-search-index="../search.json">
</form></li>
<li class="nav-item"><a class="external-link nav-link" href="https://github.com/tidyverse/glue/" aria-label="GitHub"><span class="fa fab fa-github fa-lg"></span></a></li>
      </ul>
</div>


  </div>
</nav><div class="container template-article" id="container">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">
      <img src="../logo.png" class="logo" alt=""><h1>How to write a function that wraps glue</h1>
            
      
      <small class="dont-index">Source: <a href="https://github.com/tidyverse/glue/blob/main/vignettes/wrappers.Rmd" class="external-link"><code>vignettes/wrappers.Rmd</code></a></small>
      <div class="d-none name"><code>wrappers.Rmd</code></div>
    </div>

    
    
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://glue.tidyverse.org/">glue</a></span><span class="op">)</span></span></code></pre></div>
<p>Imagine that you want to call <code><a href="../reference/glue.html">glue()</a></code> repeatedly inside
your own code (e.g. in your own package) with a non-default value for
one or more arguments. For example, maybe you anticipate producing R
code where <code>{</code> and <code>}</code> have specific syntactic
meaning. Therefore, you’d prefer to use <code>&lt;&lt;</code> and
<code>&gt;&gt;</code> as the opening and closing delimiters for
expressions in <code><a href="../reference/glue.html">glue()</a></code>.</p>
<p>Spoiler alert: here’s the correct way to write such a wrapper:</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">my_glue</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">...</span>, <span class="va">.envir</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sys.parent.html" class="external-link">parent.frame</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="fu"><a href="../reference/glue.html">glue</a></span><span class="op">(</span><span class="va">...</span>, .open <span class="op">=</span> <span class="st">"&lt;&lt;"</span>, .close <span class="op">=</span> <span class="st">"&gt;&gt;"</span>, .envir <span class="op">=</span> <span class="va">.envir</span><span class="op">)</span></span>
<span><span class="op">}</span></span></code></pre></div>
<p>This is the key move:</p>
<blockquote>
<p>Include <code>.envir = parent.frame()</code> as an argument of the
wrapper function and pass this <code>.envir</code> to the
<code>.envir</code> argument of <code><a href="../reference/glue.html">glue()</a></code>.</p>
</blockquote>
<p>If you’d like to know why this is the way, keep reading. It pays off
to understand this, because the technique applies more broadly than
glue. Once you recognize this setup, you’ll see it in many functions in
the withr, cli, and rlang packages (e.g. <code><a href="https://withr.r-lib.org/reference/defer.html" class="external-link">withr::defer()</a></code>,
<code><a href="https://cli.r-lib.org/reference/cli_abort.html" class="external-link">cli::cli_abort()</a></code>, <code><a href="https://rlang.r-lib.org/reference/abort.html" class="external-link">rlang::abort()</a></code>).</p>
<div class="section level2">
<h2 id="working-example">Working example<a class="anchor" aria-label="anchor" href="#working-example"></a>
</h2>
<p>Here’s an abbreviated excerpt of the roxygen comment that generates
the documentation for the starwars dataset in dplyr:</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">#' \describe{</span></span>
<span><span class="co">#' \item{name}{Name of the character}</span></span>
<span><span class="co">#' \item{height}{Height (cm)}</span></span>
<span><span class="co">#' \item{mass}{Weight (kg)}</span></span>
<span><span class="co">#' \item{species}{Name of species}</span></span>
<span><span class="co">#' \item{films}{List of films the character appeared in}</span></span>
<span><span class="co">#' }</span></span></code></pre></div>
<p>To produce such text programmatically, the first step might be to
generate the <code>\item</code> lines from a named list of column names
and descriptions. Notice that <code>{</code> and <code>}</code> are
important to the <code>\describe{...}</code> syntax, so this is an
example where it is nice for glue to use different delimiters for
expressions.</p>
<p>Put the metadata in a suitable list:</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">sw_meta</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>  name    <span class="op">=</span> <span class="st">"Name of the character"</span>,</span>
<span>  height  <span class="op">=</span> <span class="st">"Height (cm)"</span>,</span>
<span>  mass    <span class="op">=</span> <span class="st">"Weight (kg)"</span>,</span>
<span>  species <span class="op">=</span> <span class="st">"Name of species"</span>,</span>
<span>  films   <span class="op">=</span> <span class="st">"List of films the character appeared in"</span></span>
<span><span class="op">)</span></span></code></pre></div>
<p>Define a custom glue wrapper and use it inside another helper that
generates <code>\item</code> entries<a class="footnote-ref" tabindex="0" data-bs-toggle="popover" data-bs-content="&lt;p&gt;Note that delimiters &lt;code&gt;&amp;lt;&amp;lt;&lt;/code&gt; and
`&lt;code&gt;&amp;gt;&amp;gt;&lt;/code&gt; have special meaning in knitr, so if you’re
generating output for RMarkdown or Quarto, you should avoid them.&lt;/p&gt;"><sup>1</sup></a>:</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">my_glue</span> <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">...</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="fu"><a href="../reference/glue.html">glue</a></span><span class="op">(</span><span class="va">...</span>, .open <span class="op">=</span> <span class="st">"&lt;@"</span>, .close <span class="op">=</span> <span class="st">"@&gt;"</span>, .envir <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sys.parent.html" class="external-link">parent.frame</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="va">named_list_to_items</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="fu">my_glue</span><span class="op">(</span><span class="st">"\\item{&lt;@names(x)@&gt;}{&lt;@x@&gt;}"</span><span class="op">)</span></span>
<span><span class="op">}</span></span></code></pre></div>
<p>Apply <code>named_list_to_items()</code> to starwars metadata:</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">named_list_to_items</span><span class="op">(</span><span class="va">sw_meta</span><span class="op">)</span></span>
<span><span class="co">#&gt; \item{name}{Name of the character}</span></span>
<span><span class="co">#&gt; \item{height}{Height (cm)}</span></span>
<span><span class="co">#&gt; \item{mass}{Weight (kg)}</span></span>
<span><span class="co">#&gt; \item{species}{Name of species}</span></span>
<span><span class="co">#&gt; \item{films}{List of films the character appeared in}</span></span></code></pre></div>
<p>Here’s how this would fail if we did <em>not</em> handle
<code>.envir</code> correctly in our wrapper function:</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">my_glue_WRONG</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">...</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="fu"><a href="../reference/glue.html">glue</a></span><span class="op">(</span><span class="va">...</span>, .open <span class="op">=</span> <span class="st">"&lt;@"</span>, .close <span class="op">=</span> <span class="st">"@&gt;"</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="va">named_list_to_items_WRONG</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="fu">my_glue_WRONG</span><span class="op">(</span><span class="st">"\\item{&lt;@names(x)@&gt;}{&lt;@x@&gt;}"</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="fu">named_list_to_items_WRONG</span><span class="op">(</span><span class="va">sw_meta</span><span class="op">)</span></span>
<span><span class="co">#&gt; <span style="color: #BBBB00; font-weight: bold;">Error</span><span style="font-weight: bold;">:</span></span></span>
<span><span class="co">#&gt; <span style="color: #BBBB00;">!</span> Failed to evaluate glue component {names(x)}</span></span>
<span><span class="co">#&gt; <span style="font-weight: bold;">Caused by error:</span></span></span>
<span><span class="co">#&gt; <span style="color: #BBBB00;">!</span> object 'x' not found</span></span></code></pre></div>
<p>It can be hard to understand why <code>x</code> can’t be found, when
it is clearly available inside <code>named_list_to_items_WRONG()</code>.
Why isn’t <code>x</code> available to <code>my_glue_WRONG()</code>?</p>
</div>
<div class="section level2">
<h2 id="where-does-glue-evaluate-code">Where does <code>glue()</code> evaluate code?<a class="anchor" aria-label="anchor" href="#where-does-glue-evaluate-code"></a>
</h2>
<p>What’s going on? It’s time to look at the (redacted) signature of
<code><a href="../reference/glue.html">glue()</a></code>:</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/glue.html">glue</a></span><span class="op">(</span><span class="va">...</span>, .envir <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sys.parent.html" class="external-link">parent.frame</a></span><span class="op">(</span><span class="op">)</span>, <span class="va">...</span><span class="op">)</span></span></code></pre></div>
<p>The expressions inside a glue string are evaluated with respect to
<code>.envir</code>, which defaults to the environment where
<code><a href="../reference/glue.html">glue()</a></code> is called from.</p>
<p>Everything is simple when evaluating <code><a href="../reference/glue.html">glue()</a></code> in the
global environment:</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">x</span> <span class="op">&lt;-</span> <span class="fl">0</span></span>
<span><span class="va">y</span> <span class="op">&lt;-</span> <span class="fl">0</span></span>
<span><span class="va">z</span> <span class="op">&lt;-</span> <span class="fl">0</span></span>
<span></span>
<span><span class="fu"><a href="../reference/glue.html">glue</a></span><span class="op">(</span><span class="st">"{x} {y} {z}"</span><span class="op">)</span></span>
<span><span class="co">#&gt; 0 0 0</span></span></code></pre></div>
<p>Now we wrap <code><a href="../reference/glue.html">glue()</a></code> in our own simple function,
<code>my_glue1()</code>. Notice that <code>my_glue1()</code> does not
capture its caller environment and pass that along.</p>
<p>When we execute <code>my_glue1()</code> in the global environment,
there’s no obvious problem.</p>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">my_glue1</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">...</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">x</span> <span class="op">&lt;-</span> <span class="fl">1</span></span>
<span>  <span class="fu"><a href="../reference/glue.html">glue</a></span><span class="op">(</span><span class="va">...</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="fu">my_glue1</span><span class="op">(</span><span class="st">"{x} {y} {z}"</span><span class="op">)</span></span>
<span><span class="co">#&gt; 1 0 0</span></span></code></pre></div>
<p>The value of <code>x</code> is found in the execution environment of
<code>my_glue1()</code>. The values of <code>y</code> and <code>z</code>
are found in the global environment. Importantly, this is because that
is the environment where <code>my_glue1()</code> is defined, not because
that is where <code>my_glue1()</code> is called.</p>
<p>However, if we call our <code>my_glue1()</code> inside another
function, we see that all is not well.</p>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">my_glue2</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">...</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">x</span> <span class="op">&lt;-</span> <span class="fl">2</span></span>
<span>  <span class="va">y</span> <span class="op">&lt;-</span> <span class="fl">2</span></span>
<span>  <span class="fu">my_glue1</span><span class="op">(</span><span class="va">...</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="fu">my_glue2</span><span class="op">(</span><span class="st">"{x} {y} {z}"</span><span class="op">)</span></span>
<span><span class="co">#&gt; 1 0 0</span></span></code></pre></div>
<p>Why do <code>x</code> and <code>y</code> not have the value 2?
Because <code>my_glue1()</code> and its eventual call to
<code><a href="../reference/glue.html">glue()</a></code> have no access to the execution environment of
<code>my_glue2()</code>, which is the caller environment of
<code>my_glue1()</code>.</p>
<p>If you want your glue wrapper to behave like <code><a href="../reference/glue.html">glue()</a></code>
itself and to work as expected inside other functions, make sure it
captures its caller environment and passes that along to
<code><a href="../reference/glue.html">glue()</a></code>.</p>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">my_glue3</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">...</span>, <span class="va">.envir</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sys.parent.html" class="external-link">parent.frame</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">x</span> <span class="op">&lt;-</span> <span class="fl">3</span></span>
<span>  <span class="fu"><a href="../reference/glue.html">glue</a></span><span class="op">(</span><span class="va">...</span>, .envir <span class="op">=</span> <span class="va">.envir</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="fu">my_glue3</span><span class="op">(</span><span class="st">"{x} {y} {z}"</span><span class="op">)</span></span>
<span><span class="co">#&gt; 0 0 0</span></span>
<span></span>
<span><span class="va">my_glue4</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">...</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">x</span> <span class="op">&lt;-</span> <span class="fl">4</span></span>
<span>  <span class="va">y</span> <span class="op">&lt;-</span> <span class="fl">4</span></span>
<span>  <span class="fu">my_glue3</span><span class="op">(</span><span class="va">...</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="fu">my_glue4</span><span class="op">(</span><span class="st">"{x} {y} {z}"</span><span class="op">)</span></span>
<span><span class="co">#&gt; 4 4 0</span></span></code></pre></div>
</div>

  </main><aside class="col-md-3"><nav id="toc" aria-label="Table of contents"><h2>On this page</h2>
    </nav></aside>
</div>



   </div>
  <footer><div class="container">
  <div class="pkgdown-footer-left">
  <p>Developed by <a href="https://www.jimhester.com/" class="external-link">Jim Hester</a>, <a href="https://jennybryan.org" class="external-link">Jennifer Bryan</a>, <a href="https://www.posit.co" class="external-link"><img src="https://www.tidyverse.org/posit-logo.svg" alt="Posit" height="16" width="62" style="margin-bottom: 3px;"></a>.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.1.0.</p>
</div>

  </div></footer>
</body>
</html>
